name: Changeset Check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: read

jobs:
  check:
    name: Check for Changeset
    runs-on: ubuntu-latest
    # Skip this check if PR has 'skip-changeset' label or only changes non-package files
    if: |
      !contains(github.event.pull_request.labels.*.name, 'skip-changeset') &&
      !contains(github.event.pull_request.labels.*.name, 'dependencies')
    
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for changesets
        run: |
          # Check if there are any changesets
          if [ ! "$(ls -A .changeset/*.md 2>/dev/null | grep -v 'README.md')" ]; then
            # Check if any package files were changed
            if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q '^packages/'; then
              echo "‚ùå This PR modifies packages but doesn't include a changeset"
              echo ""
              echo "To add a changeset, run: pnpm changeset"
              echo ""
              echo "If this PR doesn't need a changeset (docs only, etc.),"
              echo "add the 'skip-changeset' label to the PR"
              echo ""
              echo "üìö Learn more: https://github.com/objectstack-ai/objectui/blob/main/CONTRIBUTING.md#versioning-and-releases"
              exit 1
            else
              echo "‚úÖ No package changes detected, skipping changeset check"
            fi
          else
            echo "‚úÖ Changeset found"
          fi

